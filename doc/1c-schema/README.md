### Структура регистров сведений 1С (входящие и исходящие очереди)

Версия DaJet Agent 6.3.3 поддерживает 4 пары регистров сведений,
которые могут использоваться в качестве входящих и исходящих очередей.

Сервис DaJet Agent умеет автоматически распознавать с какой версией
входящей или исходящей очереди (регистром сведений) он работает в данный момент.

Это распознавание выполняется по метаданным 1С и не требует остановки службы.
Другими словами пару регистров сведений можно менять с одной версии на другую в любое время - служба автоматически
адаптируется "на лету" даже при временной недоступности базы данных 1С в процессе её обновления.

Такое разнообразие версий обуславливается переходным статусом версии DaJet Agent 6.3.3.

В будущем планируется перейти к одной (эталонной) паре регистров версии 12.

**Исходящие очереди**
<table>
  <tr>
    <th>Версия 1</th>
    <th>Версия 10</th>
    <th>Версия 11</th>
    <th>Версия 12</th>
  </tr>
  <tr>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/OutgoingQueue1.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/OutgoingQueue10.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/OutgoingQueue11.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/OutgoingQueue12.png"/></td>
  </tr>
</table>

**Входящие очереди**
<table>
  <tr>
    <th>Версия 1</th>
    <th>Версия 10</th>
    <th>Версия 11</th>
    <th>Версия 12</th>
  </tr>
  <tr>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/IncomingQueue1.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/IncomingQueue10.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/IncomingQueue11.png"/></td>
    <td valign="top"><img src="https://github.com/zhichkin/dajet-agent/blob/main/doc/images/IncomingQueue12.png"/></td>
  </tr>
</table>

**Типы данных измерений, ресурсов и реквизитов**

| **Регистр сведений** | **Тип данных 1С**       | **Тип данных СУБД** | **Описание**                                          |
|----------------------|-------------------------|---------------------|-------------------------------------------------------|
| **НомерСообщения**   | Число(19,0)             | numeric(19,0)       | Порядковый номер сообщения                            |
| **Идентификатор**    | УникальныйИдентификатор | binary(16) uuid     | Идентификатор сообщения (необязательный)              |
| **Заголовки**        | Строка(0) переменная    | nvarchar(max)       | Заголовки сообщения                                   |
| **ДатаВремя**        | Дата(дата и время)      | datetime2           | Время формирования сообщения (необязательный)         |
| **ТипСообщения**     | Строка(1024) переменная | nvarchar(1024)      | Тип сообщения, например, "Справочник.Номенклатура"    |
| **ТелоСообщения**    | Строка(0) переменная    | nvarchar(max)       | Тело сообщения в формате JSON или XML                 |
| **Ссылка**           | УникальныйИдентификатор | binary(16) uuid     | Ссылка на объект 1С в теле сообщения (необязательный) |
| **Отправитель**      | Строка(36) переменная   | nvarchar(36)        | Код отправителя сообщения, передаётся в заголовках    |
| **ОписаниеОшибки**   | Строка(1024) переменная | nvarchar(1024)      | Описание ошибки, возникшей при приёме сообщения       |
| **КоличествоОшибок** | Число(2,0)              | numeric(2,0)        | Количество ошибок, возникших при приёме сообщения     |

**Примечания:**
1. В случае использования объектов СУБД sequence и/или trigger, использование поля "Идентификатор" (заполнение средствами 1С) не обязательно.
2. Все поля, имеющие пометку о необязательности, в колонке "Описание" можно не заполнять на стороне 1С.
3. Поля "ОписаниеОшибки" и "КоличествоОшибок" используются базой-приёмником 1С для блокировки входящей очереди при достижении определённого количества ошибок обработки одного и того же сообщения. Такие сообщения называются "отравленные сообщения" (poison message). Логика их обработки зависит от прикладного решения 1С.

Заголовки сообщения рекомендуется формировать в виде словаря строковых значений в формате JSON:
```JSON
{
   "Ключ1": "Значение1",
   "Ключ2": "Значение2",
   "КлючN": "ЗначениеN"
}
```

[**Эталонная подсистема для 1С** (файл cf)](https://github.com/zhichkin/dajet-agent/blob/main/1c/dajet_standard.cf)

Для организации обмена данными можно использовать эталонную подсистему для 1С,
которая использует формат [1С JDTO]() для записи и чтения сообщений.

Данная подсистема может дорабатываться под нужды конкретного прикладного решения 1С.

**Пример кода 1С для отправки исходящего сообщения**
```JavaScript
Процедура ОтправитьИсходящееСообщение(СправочникОбъект) Экспорт
	
	Набор = РегистрыСведений.ИсходящаяОчередь.СоздатьНаборЗаписей();
	Сообщение = Набор.Добавить();
	
	Сообщение.НомерСообщения = ТекущаяУниверсальнаяДатаВМиллисекундах();
	Сообщение.Идентификатор = Новый УникальныйИдентификатор();
	Сообщение.ДатаВремя = ТекущаяДатаСеанса();
	Сообщение.Заголовки = "{ ""Sender"": ""УТ"", ""Recipients"": ""БП"" }";
	Сообщение.ТипСообщения = СправочникОбъект.Метаданные().ПолноеИмя();
	Сообщение.ТелоСообщения = СформироватьТелоСообщения(СправочникОбъект);
	Сообщение.Ссылка = СправочникОбъект.Ссылка.УникальныйИдентификатор();
	
	Набор.ОбменДанными.Загрузка = Истина;
	Набор.Записать(Ложь);	
	
КонецПроцедуры

Функция СформироватьТелоСообщения(Источник)
	
	ЗаписьJSON = Новый ЗаписьJSON();
	ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет, ""));
	СериализаторXDTO.ЗаписатьJSON(ЗаписьJSON, Источник, НазначениеТипаXML.Явное);
	
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции
```